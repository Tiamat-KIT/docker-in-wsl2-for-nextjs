import { FileTree } from 'nextra/components'
import {Callout} from "nextra/components"

# [Next.jsからAndroidネイティブアプリをビルドする](https://hackmd.io/@lucasfernog/BkHI4e18j)

## ディレクトリ構成
```
/home/[ユーザ名]/<プロジェクトディレクトリ>
```

このときのディレクトリ構成は以下のようになる。

<FileTree>
  <FileTree.Folder name="プロジェクトディレクトリ" defaultOpen>
    <FileTree.File name="Dockerfile" />
    <FileTree.File name="docker-compose.yml" />
    <FileTree.Folder name="src">
      <FileTree.File name="Next.jsプロジェクト" />
    </FileTree.Folder>
  </FileTree.Folder>
</FileTree>

## 手順
### プロジェクトフォルダの作成
```bash copy
mkdir <プロジェクトフォルダ名>
```
### コード格納用フォルダ
```bash copy
cd <プロジェクトフォルダ名>
mkdir src
```

### Dockerfileの作成
まず、以前Next.jsによるWebアプリ開発を行うためのDocker環境を構築する際に<br/>
利用するDockerファイルの内容を再掲
```Dockerfile:Dockerfile
FROM node:18-alpine
WORKDIR /usr/app
```
これは、
- Node.jsのバージョン18が既に入っている環境を利用
- 作業ディレクトリを`/usr/app`にすることを示している
（[Node.js アプリケーションをDockerコンテナに取り込む方法](https://nodejs.org/ja/docs/guides/nodejs-docker-webapp)から一部参照）

Qiita記事[Docker で Tauri の環境構築する](https://qiita.com/Ritz/items/ecb4bc2d55a0d6967e6e)<br />
を参照する。この記事におけるDockerfileの記述は以下である。
```Dockerfile
FROM rust:latest

RUN apt update -y
RUN apt install -y curl
RUN apt install -y gcc
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
RUN apt update
RUN apt install -y nodejs
RUN npm install -g n
RUN n lts
RUN n prune
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN apt update
RUN apt install -y yarn

WORKDIR /var/www/ 
RUN cargo install tauri-cli
RUN apt install -y libdbus-1-dev
RUN pkg-config --libs --cflags dbus-1
RUN apt install -y software-properties-common
RUN apt update
RUN apt install -y libgtk-3-dev
RUN apt install -y build-essential
RUN apt install -y libssl-dev
RUN apt install -y libayatana-appindicator3-dev
RUN apt install -y librsvg2-dev
RUN apt install -y libwebkit2gtk-4.0-dev
# windows_host_ip を コンテナ内で Windows の ip に変更
RUN export DISPLAY=windows_host_ip:0.0 
RUN apt install -y mesa-utils
RUN apt install -y libgl1-mesa-glx
RUN export MESA_GL_VERSION_OVERRIDE=4.5
```
いうて難しい話でもない。
- 前提としてRustの最新バージョンが入っている環境を引き出す。
- aptでcurlとgccを導入。
- curlでnode.jsを導入。
- yarnを入れる。
- 作業ディレクトリでは、tauriのcliを入れる
- Tauriを動作させる上で必要なライブラリの導入
上記の6つを行っている。<br />
あとはwindowsのhostipをいじったり、OpenGL周りのものを入れているが今回は関係ない

今回は個人的な使いやすさも考え、以下のようなDockerの構成とする。
- Rustが既に入っているものを使う
- Node.jsは手動で導入する
- Bunを使う
- WORKDIRは`/usr/app`とする
- tauri-cliはBunから導入することとする。

この内容から、以下のサイトの情報をもとに、
- Qiita記事[Docker で Tauri の環境構築する](https://qiita.com/Ritz/items/ecb4bc2d55a0d6967e6e)
- Qiita記事[WSL2にNode.jsとYarnを導入する](https://zenn.dev/ryuu/articles/wsl2-addyarn)
- [Installation | Bun Docs](https://bun.sh/docs/installation)
- [Next.js | Tauri Apps](https://tauri.app/v1/guides/getting-started/setup/next-js)

この内容でDockerfileを記述する
```Dockerfile copy
FROM rust:latest

RUN apt update
RUN apt-get update
RUN apt install -y curl
RUN apt-get install -y zip
RUN apt-get install -y unzip
RUN apt install -y gcc
RUN apt install -y nodejs 
RUN apt-get install -y npm 
RUN npm install -g n
RUN n lts
RUN n prune
RUN npm install -g bun
RUN apt update
RUN apt -y install default-jdk 
RUN wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip 
RUN unzip commandlinetools-linux-8512546_latest.zip
RUN cd cmdline-tools
RUN mkdir latest
RUN mv bin latest/
RUN mv lib latest/
RUN mv NOTICE.txt latest/
RUN mv source.properties latest/
RUN cd ..
RUN mkdir ~/.android 
RUN mv cmdline-tools ~/.android
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64 
ENV ANDROID_HOME=$HOME/.android 
ENV NDK_HOME=$ANDROID_HOME/ndk/25.0.8775105

WORKDIR /usr/app
RUN apt -y install libwebkit2gtk-4.0-dev 
RUN apt -y install build-essential 
RUN apt -y install wget 
RUN apt -y install file 
RUN apt -y install libssl-dev 
RUN apt -y install libgtk-3-dev 
RUN apt -y install libayatana-appindicator3-dev 
RUN apt -y install librsvg2-dev
RUN export DISPLAY=windows_host_ip:0.0 
```

Docker側に勝手にやらせるのはここまで
```bash
bun create next-app .
bun add -d @tauri-apps/cli
bun tauri init
bun tauri dev
bun add @tauri-apps/api
```
などは後から実行する。

### docker-compose.ymlの作成
前回作成した、docker-compose.ymlと<br />
Qiita記事[Docker で Tauri の環境構築する](https://qiita.com/Ritz/items/ecb4bc2d55a0d6967e6e)<br />
のファイルの内容から考えて、

```yaml copy
version: '3'

services:
  app:
    container_name: "tauri-app"
    build: ./
    tty: true
    volumes:
      - ./src:/usr/app
    
    ports:
      - "3000:3000"
```
とするのがいい感じだろう。

### Dockerコンテナを起動する
プロジェクトフォルダ直下で以下のコマンドを実行
```bash copy
docker-compose up -d
```

こうすると、`http://localhost:3000`にアクセスする
`src`配下でNext.jsコードを作成して動かしてみる。

<Callout type="error" emoji="️🚫">
  まだちゃんと試してません！<br/>
  https://stackoverflow.com/questions/54370358/building-docker-image-causing-stat-bin-sh-no-such-file-or-directory-on-cento
</Callout>
